name: CI

  on:
    push:
      branches: [main]
    pull_request:
      branches: [main]

  jobs:
    lint-typecheck-test:
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        - uses: actions/setup-node@v4
          with:
            node-version: 20
            cache: npm

        - name: Install dependencies
          run: npm ci

        - name: Audit dependencies
          run: npm audit --audit-level=high
          continue-on-error: true

        - name: Generate Prisma client
          run: npx prisma generate

        - name: Lint
          run: npm run lint

        - name: Type check
          run: npx tsc --noEmit

        - name: Create test database
          run: DATABASE_URL="file:./test.db" npx prisma db push
  --accept-data-loss

        - name: Run tests with coverage
          run: npm run test:coverage
          env:
            SESSION_SECRET: ci-test-secret-key-for-github-actions
            DATABASE_URL: "file:./test.db"

        - name: Upload coverage report
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: coverage-report
            path: coverage/
            retention-days: 14
