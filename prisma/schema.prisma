// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model SuperAdmin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String   // bcrypt hashed
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model League {
  id            Int      @id @default(autoincrement())
  name          String   @unique  // "Thursday Night Golf League"
  slug          String   @unique  // "thursday-night-golf-league"

  // Admin credentials
  adminUsername String   // "admin@ThursdayNightGolfLeague"
  adminPassword String   // bcrypt hashed

  // Settings
  maxTeams             Int       @default(16)
  registrationOpen     Boolean   @default(true)

  // ============================================
  // HANDICAP CONFIGURATION
  // ============================================

  // --- Basic Formula: (avg - baseScore) * multiplier ---
  handicapBaseScore    Float     @default(35)       // Base score subtracted (typically par)
  handicapMultiplier   Float     @default(0.9)      // Multiplier applied to difference
  handicapRounding     String    @default("floor")  // "floor", "round", "ceil"
  handicapDefault      Float     @default(0)        // Handicap when no scores available
  handicapMax          Float?    @default(9)        // Maximum handicap cap (default: 9, set to null for no limit)
  handicapMin          Float?                       // Minimum handicap cap (null = no limit, for scratch golfers)

  // --- Score Selection ---
  handicapScoreSelection   String    @default("all")   // "all", "last_n", "best_of_last"
  handicapScoreCount       Int?                        // For "last_n": how many recent scores to use
  handicapBestOf           Int?                        // For "best_of_last": use best X scores
  handicapLastOf           Int?                        // For "best_of_last": from last Y scores
  handicapDropHighest      Int       @default(0)       // Drop N highest scores before averaging
  handicapDropLowest       Int       @default(0)       // Drop N lowest scores before averaging

  // --- Score Weighting ---
  handicapUseWeighting     Boolean   @default(false)   // Enable recency weighting
  handicapWeightRecent     Float     @default(1.5)     // Weight multiplier for most recent score
  handicapWeightDecay      Float     @default(0.9)     // Decay factor for each older score

  // --- Exceptional Score Handling ---
  handicapCapExceptional   Boolean   @default(false)   // Cap exceptional scores before averaging
  handicapExceptionalCap   Float?                      // Cap score at this value (e.g., max 50)

  // --- Time-Based Rules ---
  handicapProvWeeks        Int       @default(0)       // Provisional period in weeks (0 = disabled)
  handicapProvMultiplier   Float     @default(1.0)     // Multiplier during provisional period
  handicapFreezeWeek       Int?                        // Freeze handicaps after this week (null = never)
  handicapUseTrend         Boolean   @default(false)   // Adjust for improvement/decline trend
  handicapTrendWeight      Float     @default(0.1)     // How much to weight trend (0.1 = 10%)

  // --- Administrative ---
  handicapRequireApproval  Boolean   @default(false)   // Require admin approval for handicap changes

  // ============================================
  // SCORING CONFIGURATION
  // ============================================
  scoringType             String    @default("match_play") // "match_play" | "stroke_play" | "hybrid"

  // Stroke play settings
  strokePlayPointScale    String?   // JSON array e.g. "[10,8,6,5,4,3,2,1]" — null = use preset
  strokePlayPointPreset   String    @default("linear") // "linear" | "weighted" | "pga_style" | "custom"
  strokePlayBonusShow     Float     @default(0)       // Bonus points for showing up (0 = disabled)
  strokePlayBonusBeat     Float     @default(0)       // Bonus for beating handicap (0 = disabled)
  strokePlayDnpPoints     Float     @default(0)       // Points for "did not play" weeks
  strokePlayTieMode       String    @default("split") // "split" | "same"
  strokePlayDnpPenalty    Float     @default(0)       // Penalty for no-shows (0 = disabled)
  strokePlayMaxDnp        Int?                        // Max DNPs before excluded (null = unlimited)
  strokePlayProRate       Boolean   @default(false)   // Use points-per-round for standings

  // Hybrid mode settings
  hybridFieldWeight       Float     @default(0.5)     // Weight of field points (0-1)
  hybridFieldPointScale   String?                     // JSON point scale for field component

  // ============================================
  // SCHEDULE CONFIGURATION
  // ============================================
  scheduleType            String?                     // "single_round_robin" | "double_round_robin" | "custom" | null
  scheduleVisibility      String    @default("full")  // "full" | "current_week" | "hidden"
  byePointsMode           String    @default("flat")  // "zero" | "flat" | "league_average" | "team_average"
  byePointsFlat           Float     @default(10)      // Flat bye points amount
  scheduleExtraWeeks      String    @default("flex")  // "flex" | "continue_round"
  midSeasonAddDefault     String    @default("start_from_here") // "start_from_here" | "fill_byes" | "pro_rate" | "catch_up"
  midSeasonRemoveAction   String    @default("bye_opponents") // "bye_opponents" | "regenerate"
  playoffWeeks            Int       @default(0)       // Weeks reserved for playoffs (0 = disabled)
  playoffTeams            Int       @default(4)       // Teams qualifying for playoffs
  playoffFormat           String    @default("single_elimination") // "single_elimination" | "double_elimination" | "round_robin"

  // ============================================
  // PLAY MODE (9-Hole / Shotgun)
  // ============================================
  playMode              String @default("full_18")   // "full_18" | "nine_hole_alternating" | "nine_hole_front" | "nine_hole_back"
  playModeFirstWeekSide String @default("front")     // "front" | "back" — which side week 1 plays (alternating mode)

  // About the League fields (all optional)
  startDate            DateTime?
  endDate              DateTime?
  numberOfWeeks        Int?
  courseName           String?
  courseLocation       String?
  playDay              String?   // Day of week (e.g., "Thursday")
  playTime             String?   // Start time (e.g., "5:30 PM")
  entryFee             Float?
  prizeInfo            String?
  description          String?
  contactEmail         String?
  contactPhone         String?

  // Platform management (for super-admin)
  status           String    @default("active")  // "active", "suspended", "cancelled"
  subscriptionTier String    @default("free")    // "free", "basic", "pro" (future billing)
  billingEmail     String?
  expiresAt        DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Scorecard configuration
  scorecardMode             String    @default("disabled") // "disabled" | "optional" | "required"
  scorecardRequireApproval  Boolean   @default(true)

  // Relations
  teams             Team[]
  matchups          Matchup[]
  seasons           Season[]
  weeklyScores      WeeklyScore[]
  scheduledMatchups ScheduledMatchup[]
  scorecards        Scorecard[]
  courses           Course[]
}

model Season {
  id            Int       @id @default(autoincrement())
  leagueId      Int
  league        League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  name          String    // "2024 Season", "Spring 2025"
  year          Int       // 2024, 2025
  seasonNumber  Int       // 1, 2, 3... (order within league)
  isActive      Boolean   @default(true)

  scoringType   String?   // Snapshot of league.scoringType at season creation

  startDate     DateTime?
  endDate       DateTime?
  numberOfWeeks Int?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  matchups          Matchup[]
  teams             Team[]
  weeklyScores      WeeklyScore[]
  scheduledMatchups ScheduledMatchup[]
  scorecards        Scorecard[]

  @@unique([leagueId, seasonNumber])
  @@index([leagueId])
}

model Team {
  id          Int       @id @default(autoincrement())
  name        String

  // League association
  leagueId    Int
  league      League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  // Season association (teams belong to specific season)
  seasonId    Int?
  season      Season?   @relation(fields: [seasonId], references: [id])

  // Captain/Contact information
  captainName String?
  email       String?
  phone       String?

  // Registration status
  status      String    @default("pending") // "pending", "approved", "rejected"

  // League stats (per season)
  totalPoints Float     @default(0)
  wins        Int       @default(0)
  losses      Int       @default(0)
  ties        Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  matchupsAsTeamA Matchup[] @relation("TeamA")
  matchupsAsTeamB Matchup[] @relation("TeamB")
  weeklyScores      WeeklyScore[]
  scheduledAsTeamA  ScheduledMatchup[] @relation("ScheduledTeamA")
  scheduledAsTeamB  ScheduledMatchup[] @relation("ScheduledTeamB")
  scorecards        Scorecard[]

  // Team name must be unique within a season (allows same team name across seasons)
  @@unique([seasonId, name])
  @@index([leagueId])
  @@index([seasonId])
}

model Matchup {
  id              Int      @id @default(autoincrement())
  weekNumber      Int
  playedAt        DateTime @default(now())

  // League association
  leagueId        Int
  league          League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  // Season association
  seasonId        Int?
  season          Season?  @relation(fields: [seasonId], references: [id])

  // Team A data
  teamAId         Int
  teamA           Team     @relation("TeamA", fields: [teamAId], references: [id])
  teamAGross      Int      // Gross score entered by admin
  teamAHandicap   Float    // Handicap at time of match
  teamANet        Float    // Calculated: Gross - Handicap
  teamAPoints     Float    // Points awarded (can be overridden)
  teamAIsSub      Boolean  @default(false) // True if substitute played (excludes from handicap calc)

  // Team B data
  teamBId         Int
  teamB           Team     @relation("TeamB", fields: [teamBId], references: [id])
  teamBGross      Int
  teamBHandicap   Float
  teamBNet        Float
  teamBPoints     Float
  teamBIsSub      Boolean  @default(false) // True if substitute played (excludes from handicap calc)

  // Forfeit data
  isForfeit       Boolean  @default(false) // True if this was a forfeit match
  forfeitTeamId   Int?     // ID of the team that forfeited (null if not a forfeit)

  // Schedule link
  scheduledMatchup ScheduledMatchup?

  // Scorecard link
  scorecards      Scorecard[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Constraint: unique matchup per week per team pair within a league
  @@unique([leagueId, weekNumber, teamAId, teamBId])
  @@index([leagueId])
  @@index([seasonId])
  @@index([teamAId])
  @@index([teamBId])
  @@index([leagueId, weekNumber])
}

model WeeklyScore {
  id          Int       @id @default(autoincrement())
  weekNumber  Int
  leagueId    Int
  seasonId    Int?
  teamId      Int
  grossScore  Int
  handicap    Float
  netScore    Float
  points      Float     // Points awarded based on weekly finish position
  position    Int       // Finish position for this week (1st, 2nd, etc.)
  isSub       Boolean   @default(false)
  isDnp       Boolean   @default(false) // Did Not Play
  playedAt    DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  league  League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  season  Season?  @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  team    Team     @relation(fields: [teamId], references: [id], onDelete: Restrict)
  scorecard Scorecard?

  @@unique([leagueId, weekNumber, teamId])
  @@index([leagueId])
  @@index([seasonId])
  @@index([teamId])
  @@index([leagueId, weekNumber])
}

model ScheduledMatchup {
  id          Int       @id @default(autoincrement())
  leagueId    Int
  seasonId    Int?
  weekNumber  Int
  teamAId     Int
  teamBId     Int?      // Null = bye week for teamA
  status      String    @default("scheduled") // "scheduled" | "completed" | "cancelled"
  startingHole Int?     // Shotgun: which hole this group starts on (1-18)
  courseSide   String?  // "front" | "back" | null — which 9 are in play
  matchupId   Int?      @unique // Links to actual Matchup when completed
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  league  League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  season  Season?  @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  teamA   Team     @relation("ScheduledTeamA", fields: [teamAId], references: [id], onDelete: Restrict)
  teamB   Team?    @relation("ScheduledTeamB", fields: [teamBId], references: [id], onDelete: Restrict)
  matchup Matchup? @relation(fields: [matchupId], references: [id], onDelete: SetNull)

  @@unique([leagueId, weekNumber, teamAId])
  @@index([leagueId])
  @@index([seasonId])
  @@index([teamAId])
  @@index([teamBId])
  @@index([leagueId, weekNumber])
  @@index([matchupId])
}

// ============================================
// SCORECARD MODELS
// ============================================

model Course {
  id            Int      @id @default(autoincrement())
  leagueId      Int
  league        League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  name          String
  location      String?
  numberOfHoles Int      @default(9)    // 9 or 18
  totalPar      Int?                    // computed sum of hole pars
  teeColor      String?                // "White", "Blue", etc.
  courseRating   Float?                 // USGA Course Rating
  slopeRating   Int?                   // USGA Slope Rating
  externalId    String?                // for future API import
  dataSource    String   @default("manual")  // "manual" | "golfcourseapi" | etc.
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  holes         Hole[]
  scorecards    Scorecard[]

  @@index([leagueId])
}

model Hole {
  id            Int    @id @default(autoincrement())
  courseId       Int
  course        Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  holeNumber    Int       // 1-9 or 1-18
  par           Int       // 3, 4, or 5
  handicapIndex Int       // 1-18 difficulty ranking (1 = hardest)
  yardage       Int?
  holeScores    HoleScore[]

  @@unique([courseId, holeNumber])
  @@index([courseId])
}

model Scorecard {
  id            Int       @id @default(autoincrement())
  leagueId      Int
  league        League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  courseId       Int
  course        Course    @relation(fields: [courseId], references: [id])
  teamId        Int
  team          Team      @relation(fields: [teamId], references: [id])
  seasonId      Int?
  season        Season?   @relation(fields: [seasonId], references: [id])
  weekNumber    Int
  matchupId     Int?
  matchup       Matchup?  @relation(fields: [matchupId], references: [id], onDelete: SetNull)
  teamSide      String?   // "A" or "B" for match play
  courseSide    String?   // "front" | "back" | null — snapshot from ScheduledMatchup at creation
  weeklyScoreId Int?      @unique
  weeklyScore   WeeklyScore? @relation(fields: [weeklyScoreId], references: [id], onDelete: SetNull)
  grossTotal    Int?      // sum of hole strokes (null if incomplete)
  frontNine     Int?
  backNine      Int?
  status        String    @default("in_progress")  // in_progress | completed | approved | rejected
  playerName    String?   // who actually played
  accessToken   String?   @unique   // JWT for shareable link
  tokenExpiresAt DateTime?
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  approvedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  holeScores    HoleScore[]

  @@unique([leagueId, weekNumber, teamId])
  @@index([leagueId, weekNumber])
  @@index([teamId])
  @@index([seasonId])
  @@index([courseId])
}

model HoleScore {
  id          Int       @id @default(autoincrement())
  scorecardId  Int
  scorecard   Scorecard @relation(fields: [scorecardId], references: [id], onDelete: Cascade)
  holeId      Int
  hole        Hole      @relation(fields: [holeId], references: [id])
  holeNumber  Int       // denormalized
  strokes     Int
  putts       Int?
  fairwayHit  Boolean?
  greenInReg  Boolean?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([scorecardId, holeNumber])
  @@index([scorecardId])
}
