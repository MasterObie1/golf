// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model SuperAdmin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String   // bcrypt hashed
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model League {
  id            Int      @id @default(autoincrement())
  name          String   @unique  // "Thursday Night Golf League"
  slug          String   @unique  // "thursday-night-golf-league"

  // Admin credentials
  adminUsername String   // "admin@ThursdayNightGolfLeague"
  adminPassword String   // bcrypt hashed

  // Settings
  maxTeams             Int       @default(16)
  registrationOpen     Boolean   @default(true)

  // ============================================
  // HANDICAP CONFIGURATION
  // ============================================

  // --- Basic Formula: (avg - baseScore) * multiplier ---
  handicapBaseScore    Float     @default(35)       // Base score subtracted (typically par)
  handicapMultiplier   Float     @default(0.9)      // Multiplier applied to difference
  handicapRounding     String    @default("floor")  // "floor", "round", "ceil"
  handicapDefault      Float     @default(0)        // Handicap when no scores available
  handicapMax          Float?    @default(9)        // Maximum handicap cap (null = no limit)
  handicapMin          Float?                       // Minimum handicap cap (null = no limit, for scratch golfers)

  // --- Score Selection ---
  handicapScoreSelection   String    @default("all")   // "all", "last_n", "best_of_last"
  handicapScoreCount       Int?                        // For "last_n": how many recent scores to use
  handicapBestOf           Int?                        // For "best_of_last": use best X scores
  handicapLastOf           Int?                        // For "best_of_last": from last Y scores
  handicapDropHighest      Int       @default(0)       // Drop N highest scores before averaging
  handicapDropLowest       Int       @default(0)       // Drop N lowest scores before averaging

  // --- Score Weighting ---
  handicapUseWeighting     Boolean   @default(false)   // Enable recency weighting
  handicapWeightRecent     Float     @default(1.5)     // Weight multiplier for most recent score
  handicapWeightDecay      Float     @default(0.9)     // Decay factor for each older score

  // --- Exceptional Score Handling ---
  handicapCapExceptional   Boolean   @default(false)   // Cap exceptional scores before averaging
  handicapExceptionalCap   Float?                      // Cap score at this value (e.g., max 50)

  // --- Time-Based Rules ---
  handicapProvWeeks        Int       @default(0)       // Provisional period in weeks (0 = disabled)
  handicapProvMultiplier   Float     @default(1.0)     // Multiplier during provisional period
  handicapFreezeWeek       Int?                        // Freeze handicaps after this week (null = never)
  handicapUseTrend         Boolean   @default(false)   // Adjust for improvement/decline trend
  handicapTrendWeight      Float     @default(0.1)     // How much to weight trend (0.1 = 10%)

  // --- Administrative ---
  handicapRequireApproval  Boolean   @default(false)   // Require admin approval for handicap changes

  // About the League fields (all optional)
  startDate            DateTime?
  endDate              DateTime?
  numberOfWeeks        Int?
  courseName           String?
  courseLocation       String?
  playDay              String?   // Day of week (e.g., "Thursday")
  playTime             String?   // Start time (e.g., "5:30 PM")
  entryFee             Float?
  prizeInfo            String?
  description          String?
  contactEmail         String?
  contactPhone         String?

  // Platform management (for super-admin)
  status           String    @default("active")  // "active", "suspended", "cancelled"
  subscriptionTier String    @default("free")    // "free", "basic", "pro" (future billing)
  billingEmail     String?
  expiresAt        DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teams       Team[]
  matchups    Matchup[]
  seasons     Season[]
}

model Season {
  id            Int       @id @default(autoincrement())
  leagueId      Int
  league        League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  name          String    // "2024 Season", "Spring 2025"
  year          Int       // 2024, 2025
  seasonNumber  Int       // 1, 2, 3... (order within league)
  isActive      Boolean   @default(true)

  startDate     DateTime?
  endDate       DateTime?
  numberOfWeeks Int?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  matchups      Matchup[]
  teams         Team[]

  @@unique([leagueId, seasonNumber])
  @@index([leagueId])
}

model Team {
  id          Int       @id @default(autoincrement())
  name        String

  // League association
  leagueId    Int
  league      League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  // Season association (teams belong to specific season)
  seasonId    Int?
  season      Season?   @relation(fields: [seasonId], references: [id])

  // Captain/Contact information
  captainName String?
  email       String?
  phone       String?

  // Registration status
  status      String    @default("pending") // "pending", "approved", "rejected"

  // League stats (per season)
  totalPoints Float     @default(0)
  wins        Int       @default(0)
  losses      Int       @default(0)
  ties        Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  matchupsAsTeamA Matchup[] @relation("TeamA")
  matchupsAsTeamB Matchup[] @relation("TeamB")

  // Team name must be unique within a season (allows same team name across seasons)
  @@unique([seasonId, name])
  @@index([leagueId])
  @@index([seasonId])
}

model Matchup {
  id              Int      @id @default(autoincrement())
  weekNumber      Int
  playedAt        DateTime @default(now())

  // League association
  leagueId        Int
  league          League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  // Season association
  seasonId        Int?
  season          Season?  @relation(fields: [seasonId], references: [id])

  // Team A data
  teamAId         Int
  teamA           Team     @relation("TeamA", fields: [teamAId], references: [id])
  teamAGross      Int      // Gross score entered by admin
  teamAHandicap   Float    // Handicap at time of match
  teamANet        Float    // Calculated: Gross - Handicap
  teamAPoints     Float    // Points awarded (can be overridden)
  teamAIsSub      Boolean  @default(false) // True if substitute played (excludes from handicap calc)

  // Team B data
  teamBId         Int
  teamB           Team     @relation("TeamB", fields: [teamBId], references: [id])
  teamBGross      Int
  teamBHandicap   Float
  teamBNet        Float
  teamBPoints     Float
  teamBIsSub      Boolean  @default(false) // True if substitute played (excludes from handicap calc)

  // Forfeit data
  isForfeit       Boolean  @default(false) // True if this was a forfeit match
  forfeitTeamId   Int?     // ID of the team that forfeited (null if not a forfeit)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Constraint: unique matchup per week per team pair within a league
  @@unique([leagueId, weekNumber, teamAId, teamBId])
  @@index([leagueId])
  @@index([seasonId])
  @@index([teamAId])
  @@index([teamBId])
  @@index([leagueId, weekNumber])
}
